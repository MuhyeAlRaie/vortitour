<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tours - VORTITOUR</title>
    <meta name="description" content="Manage and organize your virtual tours">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/main.css">
    
    <!-- Configuration -->
    <script src="../config.js"></script>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="../index.html">
                <i class="bi bi-globe me-2"></i>
                VORTITOUR
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-speedometer2 me-1"></i>
                            <span data-i18n="nav.dashboard">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="tours.html">
                            <i class="bi bi-collection me-1"></i>
                            <span data-i18n="nav.tours">Tours</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="editor.html">
                            <i class="bi bi-pencil-square me-1"></i>
                            <span data-i18n="nav.editor">Editor</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="analytics.html">
                            <i class="bi bi-graph-up me-1"></i>
                            <span data-i18n="nav.analytics">Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">
                            <i class="bi bi-gear me-1"></i>
                            <span data-i18n="nav.settings">Settings</span>
                        </a>
                    </li>
                </ul>
                
                <div class="navbar-nav">
                    <div class="language-toggle me-3" id="language-toggle">
                        <i class="bi bi-translate me-1"></i>
                        <span id="current-language">EN</span>
                    </div>
                    
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="user-name">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="profile.html">
                                <i class="bi bi-person me-2"></i>
                                <span data-i18n="nav.profile">Profile</span>
                            </a></li>
                            <li><a class="dropdown-item" href="settings.html">
                                <i class="bi bi-gear me-2"></i>
                                <span data-i18n="nav.settings">Settings</span>
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-btn">
                                <i class="bi bi-box-arrow-right me-2"></i>
                                <span data-i18n="nav.logout">Logout</span>
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-1" data-i18n="tours.title">My Tours</h1>
                        <p class="text-muted mb-0" data-i18n="tours.subtitle">Manage and organize your virtual tours</p>
                    </div>
                    <div>
                        <a href="editor.html" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>
                            <span data-i18n="tours.createNew">Create New Tour</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" placeholder="Search tours..." id="search-input">
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-2">
                    <select class="form-select" id="status-filter">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="published">Published</option>
                        <option value="archived">Archived</option>
                    </select>
                    <select class="form-select" id="category-filter">
                        <option value="">All Categories</option>
                        <option value="real-estate">Real Estate</option>
                        <option value="hospitality">Hospitality</option>
                        <option value="retail">Retail</option>
                        <option value="education">Education</option>
                        <option value="museum">Museum</option>
                    </select>
                    <button class="btn btn-outline-secondary" id="view-toggle" title="Toggle View">
                        <i class="bi bi-grid-3x3-gap"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tours Grid -->
        <div id="tours-container">
            <div class="row" id="tours-grid">
                <!-- Tours will be populated here -->
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-5" style="display: none;">
            <i class="bi bi-collection fs-1 text-muted mb-3"></i>
            <h4 class="text-muted" data-i18n="tours.noTours">No tours found</h4>
            <p class="text-muted mb-4" data-i18n="tours.noToursDesc">Create your first virtual tour to get started</p>
            <a href="editor.html" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>
                <span data-i18n="tours.createFirst">Create Your First Tour</span>
            </a>
        </div>
    </div>

    <!-- Tour Actions Modal -->
    <div class="modal fade" id="tour-actions-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-tour-title">Tour Actions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="edit-tour-btn">
                            <i class="bi bi-pencil-square me-2"></i>
                            Edit Tour
                        </button>
                        <button class="btn btn-outline-info" id="preview-tour-btn">
                            <i class="bi bi-eye me-2"></i>
                            Preview Tour
                        </button>
                        <button class="btn btn-outline-success" id="share-tour-btn">
                            <i class="bi bi-share me-2"></i>
                            Share Tour
                        </button>
                        <button class="btn btn-outline-secondary" id="duplicate-tour-btn">
                            <i class="bi bi-files me-2"></i>
                            Duplicate Tour
                        </button>
                        <button class="btn btn-outline-warning" id="archive-tour-btn">
                            <i class="bi bi-archive me-2"></i>
                            Archive Tour
                        </button>
                        <button class="btn btn-outline-danger" id="delete-tour-btn">
                            <i class="bi bi-trash me-2"></i>
                            Delete Tour
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/analytics.js"></script>

    <script>
        // Tours Management Application
        class ToursApp {
            constructor() {
                this.tours = [];
                this.filteredTours = [];
                this.currentView = 'grid';
                this.selectedTour = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadTours();
                this.trackPageView();
            }

            setupEventListeners() {
                // Search and filters
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.filterTours();
                });

                document.getElementById('status-filter').addEventListener('change', () => {
                    this.filterTours();
                });

                document.getElementById('category-filter').addEventListener('change', () => {
                    this.filterTours();
                });

                // View toggle
                document.getElementById('view-toggle').addEventListener('click', () => {
                    this.toggleView();
                });

                // Modal actions
                document.getElementById('edit-tour-btn').addEventListener('click', () => {
                    this.editTour();
                });

                document.getElementById('preview-tour-btn').addEventListener('click', () => {
                    this.previewTour();
                });

                document.getElementById('share-tour-btn').addEventListener('click', () => {
                    this.shareTour();
                });

                document.getElementById('duplicate-tour-btn').addEventListener('click', () => {
                    this.duplicateTour();
                });

                document.getElementById('archive-tour-btn').addEventListener('click', () => {
                    this.archiveTour();
                });

                document.getElementById('delete-tour-btn').addEventListener('click', () => {
                    this.deleteTour();
                });
            }

            async loadTours() {
                try {
                    // Load tours from Supabase
                    if (window.VortitourSupabase) {
                        this.tours = await window.VortitourSupabase.getUserTours();
                    } else {
                        // Demo data
                        this.tours = this.generateDemoTours();
                    }

                    this.filteredTours = [...this.tours];
                    this.renderTours();

                } catch (error) {
                    console.error('Error loading tours:', error);
                    this.showToast('Failed to load tours', 'error');
                }
            }

            generateDemoTours() {
                return [
                    {
                        id: '1',
                        name: 'Modern Apartment Showcase',
                        description: 'Luxury 2-bedroom apartment in downtown',
                        category: 'real-estate',
                        status: 'published',
                        scenes: 8,
                        views: 1234,
                        created_at: '2024-01-15',
                        updated_at: '2024-01-20',
                        thumbnail: 'https://via.placeholder.com/300x200/007bff/ffffff?text=Modern+Apartment'
                    },
                    {
                        id: '2',
                        name: 'Hotel Suite Experience',
                        description: 'Premium hotel suite virtual tour',
                        category: 'hospitality',
                        status: 'published',
                        scenes: 12,
                        views: 856,
                        created_at: '2024-01-10',
                        updated_at: '2024-01-18',
                        thumbnail: 'https://via.placeholder.com/300x200/28a745/ffffff?text=Hotel+Suite'
                    },
                    {
                        id: '3',
                        name: 'Retail Store Layout',
                        description: 'Fashion boutique store tour',
                        category: 'retail',
                        status: 'draft',
                        scenes: 6,
                        views: 0,
                        created_at: '2024-01-22',
                        updated_at: '2024-01-22',
                        thumbnail: 'https://via.placeholder.com/300x200/ffc107/ffffff?text=Retail+Store'
                    }
                ];
            }

            filterTours() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const statusFilter = document.getElementById('status-filter').value;
                const categoryFilter = document.getElementById('category-filter').value;

                this.filteredTours = this.tours.filter(tour => {
                    const matchesSearch = tour.name.toLowerCase().includes(searchTerm) ||
                                        tour.description.toLowerCase().includes(searchTerm);
                    const matchesStatus = !statusFilter || tour.status === statusFilter;
                    const matchesCategory = !categoryFilter || tour.category === categoryFilter;

                    return matchesSearch && matchesStatus && matchesCategory;
                });

                this.renderTours();
            }

            renderTours() {
                const container = document.getElementById('tours-grid');
                const emptyState = document.getElementById('empty-state');

                if (this.filteredTours.length === 0) {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }

                emptyState.style.display = 'none';
                
                if (this.currentView === 'grid') {
                    this.renderGridView(container);
                } else {
                    this.renderListView(container);
                }
            }

            renderGridView(container) {
                container.innerHTML = this.filteredTours.map(tour => `
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card tour-card h-100" data-tour-id="${tour.id}">
                            <div class="position-relative">
                                <img src="${tour.thumbnail}" class="card-img-top" alt="${tour.name}" style="height: 200px; object-fit: cover;">
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge bg-${this.getStatusColor(tour.status)}">${tour.status}</span>
                                </div>
                                <div class="position-absolute bottom-0 start-0 m-2">
                                    <span class="badge bg-dark">${tour.scenes} scenes</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">${tour.name}</h5>
                                <p class="card-text text-muted small">${tour.description}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="bi bi-eye me-1"></i>
                                        ${tour.views} views
                                    </small>
                                    <small class="text-muted">
                                        ${this.formatDate(tour.updated_at)}
                                    </small>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100">
                                    <button class="btn btn-outline-primary btn-sm" onclick="toursApp.editTourDirect('${tour.id}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="toursApp.previewTourDirect('${tour.id}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="toursApp.showTourActions('${tour.id}')">
                                        <i class="bi bi-three-dots"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            renderListView(container) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Scenes</th>
                                        <th>Views</th>
                                        <th>Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.filteredTours.map(tour => `
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img src="${tour.thumbnail}" alt="${tour.name}" 
                                                         class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                                    <div>
                                                        <h6 class="mb-0">${tour.name}</h6>
                                                        <small class="text-muted">${tour.description}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><span class="badge bg-secondary">${tour.category}</span></td>
                                            <td><span class="badge bg-${this.getStatusColor(tour.status)}">${tour.status}</span></td>
                                            <td>${tour.scenes}</td>
                                            <td>${tour.views}</td>
                                            <td>${this.formatDate(tour.updated_at)}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="toursApp.editTourDirect('${tour.id}')">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-outline-info" onclick="toursApp.previewTourDirect('${tour.id}')">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary" onclick="toursApp.showTourActions('${tour.id}')">
                                                        <i class="bi bi-three-dots"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            toggleView() {
                this.currentView = this.currentView === 'grid' ? 'list' : 'grid';
                const icon = document.querySelector('#view-toggle i');
                icon.className = this.currentView === 'grid' ? 'bi bi-grid-3x3-gap' : 'bi bi-list';
                this.renderTours();
            }

            showTourActions(tourId) {
                this.selectedTour = this.tours.find(t => t.id === tourId);
                if (this.selectedTour) {
                    document.getElementById('modal-tour-title').textContent = this.selectedTour.name;
                    const modal = new bootstrap.Modal(document.getElementById('tour-actions-modal'));
                    modal.show();
                }
            }

            editTourDirect(tourId) {
                window.location.href = `editor.html?tour=${tourId}`;
            }

            previewTourDirect(tourId) {
                window.open(`viewer.html?tour=${tourId}&preview=true`, '_blank');
            }

            editTour() {
                if (this.selectedTour) {
                    window.location.href = `editor.html?tour=${this.selectedTour.id}`;
                }
            }

            previewTour() {
                if (this.selectedTour) {
                    window.open(`viewer.html?tour=${this.selectedTour.id}&preview=true`, '_blank');
                }
            }

            shareTour() {
                if (this.selectedTour) {
                    // Implement sharing functionality
                    this.showToast('Sharing functionality would be implemented here', 'info');
                }
            }

            async duplicateTour() {
                if (this.selectedTour) {
                    try {
                        // Duplicate tour logic
                        const duplicatedTour = {
                            ...this.selectedTour,
                            id: Date.now().toString(),
                            name: `${this.selectedTour.name} (Copy)`,
                            status: 'draft',
                            views: 0,
                            created_at: new Date().toISOString().split('T')[0]
                        };

                        this.tours.push(duplicatedTour);
                        this.filterTours();
                        this.showToast('Tour duplicated successfully', 'success');

                        bootstrap.Modal.getInstance(document.getElementById('tour-actions-modal')).hide();

                    } catch (error) {
                        console.error('Error duplicating tour:', error);
                        this.showToast('Failed to duplicate tour', 'error');
                    }
                }
            }

            async archiveTour() {
                if (this.selectedTour && confirm('Are you sure you want to archive this tour?')) {
                    try {
                        this.selectedTour.status = 'archived';
                        this.filterTours();
                        this.showToast('Tour archived successfully', 'success');

                        bootstrap.Modal.getInstance(document.getElementById('tour-actions-modal')).hide();

                    } catch (error) {
                        console.error('Error archiving tour:', error);
                        this.showToast('Failed to archive tour', 'error');
                    }
                }
            }

            async deleteTour() {
                if (this.selectedTour && confirm('Are you sure you want to delete this tour? This action cannot be undone.')) {
                    try {
                        this.tours = this.tours.filter(t => t.id !== this.selectedTour.id);
                        this.filterTours();
                        this.showToast('Tour deleted successfully', 'success');

                        bootstrap.Modal.getInstance(document.getElementById('tour-actions-modal')).hide();

                    } catch (error) {
                        console.error('Error deleting tour:', error);
                        this.showToast('Failed to delete tour', 'error');
                    }
                }
            }

            getStatusColor(status) {
                const colors = {
                    'draft': 'warning',
                    'published': 'success',
                    'archived': 'secondary'
                };
                return colors[status] || 'secondary';
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString();
            }

            showToast(message, type = 'info') {
                if (window.VortitourApp && window.VortitourApp.showToast) {
                    window.VortitourApp.showToast(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            trackPageView() {
                if (window.VortitourAnalytics) {
                    window.VortitourAnalytics.trackEvent('tours_page_viewed', {
                        tours_count: this.tours.length
                    });
                }
            }
        }

        // Initialize tours app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize i18n
            if (window.VortitourI18n) {
                window.VortitourI18n.init();
            }
            
            // Initialize tours app
            window.toursApp = new ToursApp();
        });
    </script>
</body>
</html>

