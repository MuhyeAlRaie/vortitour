<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Tour Viewer - VORTITOUR</title>
    <meta name="description" content="Experience immersive 360Â° virtual tours with VR support">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- A-Frame VR -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/supermedium/superframe@master/components/environment/dist/aframe-environment-component.min.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/main.css">
    
    <!-- Configuration -->
    <script src="../../config.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #vr-scene {
            width: 100vw;
            height: 100vh;
        }
        
        .viewer-ui {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .viewer-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50px;
            padding: 10px 20px;
            backdrop-filter: blur(10px);
        }
        
        .control-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.2rem;
            margin: 0 10px;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #007bff;
        }
        
        .scene-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }
        
        .hotspot {
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #007bff, #0056b3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 1.2rem;
        }
        
        .demo-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffa500);
            color: white;
            text-align: center;
            padding: 10px;
            z-index: 1001;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-light mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div>Loading Virtual Tour...</div>
        </div>
    </div>

    <!-- Demo Banner -->
    <div id="demo-banner" class="demo-banner d-none">
        ðŸŽ® DEMO MODE - Experience VORTITOUR Virtual Tour Technology
    </div>

    <!-- Viewer UI -->
    <div class="viewer-ui">
        <h6 class="mb-2">
            <i class="bi bi-camera-reels me-2"></i>
            <span id="tour-title">Virtual Tour</span>
        </h6>
        <small class="text-muted" id="scene-info">Scene 1 of 3</small>
    </div>

    <!-- Scene Selector -->
    <div class="scene-selector">
        <select class="form-select form-select-sm" id="scene-selector" style="background: rgba(255,255,255,0.1); border: none; color: white;">
            <option value="scene1">Living Room</option>
            <option value="scene2">Kitchen</option>
            <option value="scene3">Bedroom</option>
        </select>
    </div>

    <!-- VR Scene -->
    <a-scene id="vr-scene" embedded style="height: 100vh; width: 100vw;" 
             vr-mode-ui="enabled: true" 
             device-orientation-permission-ui="enabled: true"
             background="color: #000">
        
        <!-- Assets -->
        <a-assets>
            <!-- Demo 360 images -->
            <img id="living-room" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg" crossorigin="anonymous">
            <img id="kitchen" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/cubes.jpg" crossorigin="anonymous">
            <img id="bedroom" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/city.jpg" crossorigin="anonymous">
            
            <!-- Hotspot assets -->
            <a-mixin id="hotspot-mixin" 
                     geometry="primitive: sphere; radius: 0.1" 
                     material="color: #007bff; opacity: 0.8; transparent: true"
                     animation="property: rotation; to: 0 360 0; loop: true; dur: 10000"
                     class="hotspot"></a-mixin>
        </a-assets>

        <!-- Sky (360 image) -->
        <a-sky id="scene-sky" src="#living-room" rotation="0 -130 0"></a-sky>

        <!-- Hotspots -->
        <a-entity id="hotspot1" 
                  mixin="hotspot-mixin"
                  position="2 1 -3"
                  data-scene="kitchen"
                  data-title="Go to Kitchen">
            <a-text value="Kitchen" 
                    position="0 0.3 0" 
                    align="center" 
                    color="white"
                    scale="0.5 0.5 0.5"></a-text>
        </a-entity>

        <a-entity id="hotspot2" 
                  mixin="hotspot-mixin"
                  position="-2 1 -3"
                  data-scene="bedroom"
                  data-title="Go to Bedroom">
            <a-text value="Bedroom" 
                    position="0 0.3 0" 
                    align="center" 
                    color="white"
                    scale="0.5 0.5 0.5"></a-text>
        </a-entity>

        <!-- Info hotspot -->
        <a-entity id="info-hotspot" 
                  geometry="primitive: cylinder; radius: 0.1; height: 0.3" 
                  material="color: #28a745; opacity: 0.8"
                  position="0 0.5 -2"
                  animation="property: position; to: 0 0.7 -2; dir: alternate; loop: true; dur: 2000">
            <a-text value="â„¹ï¸ Info" 
                    position="0 0.4 0" 
                    align="center" 
                    color="white"
                    scale="0.4 0.4 0.4"></a-text>
        </a-entity>

        <!-- Camera with controls -->
        <a-entity id="camera-rig" position="0 1.6 0">
            <a-camera id="main-camera" 
                      look-controls="enabled: true; pointerLockEnabled: false"
                      wasd-controls="enabled: false"
                      cursor="rayOrigin: mouse; fuse: false"
                      raycaster="objects: .hotspot">
            </a-camera>
        </a-entity>

        <!-- Lighting -->
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        <a-light type="directional" position="0 1 0" color="#ffffff" intensity="0.6"></a-light>
    </a-scene>

    <!-- Viewer Controls -->
    <div class="viewer-controls">
        <button class="control-btn" id="prev-scene" title="Previous Scene">
            <i class="bi bi-chevron-left"></i>
        </button>
        <button class="control-btn" id="play-pause" title="Auto Rotate">
            <i class="bi bi-play"></i>
        </button>
        <button class="control-btn" id="fullscreen" title="Fullscreen">
            <i class="bi bi-fullscreen"></i>
        </button>
        <button class="control-btn" id="vr-mode" title="Enter VR">
            <i class="bi bi-headset-vr"></i>
        </button>
        <button class="control-btn" id="next-scene" title="Next Scene">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>

    <!-- Scripts -->
    <script src="../js/i18n.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/analytics.js"></script>

    <script>
        // Virtual Tour Viewer Application
        class VRTourViewer {
            constructor() {
                this.currentScene = 0;
                this.scenes = [
                    { id: 'scene1', name: 'Living Room', sky: '#living-room' },
                    { id: 'scene2', name: 'Kitchen', sky: '#kitchen' },
                    { id: 'scene3', name: 'Bedroom', sky: '#bedroom' }
                ];
                this.isAutoRotating = false;
                this.tourData = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadTourData();
                this.setupHotspotInteractions();
                this.hideLoading();
                this.trackView();
            }

            setupEventListeners() {
                // Scene navigation
                document.getElementById('prev-scene').addEventListener('click', () => this.previousScene());
                document.getElementById('next-scene').addEventListener('click', () => this.nextScene());
                document.getElementById('play-pause').addEventListener('click', () => this.toggleAutoRotate());
                document.getElementById('fullscreen').addEventListener('click', () => this.toggleFullscreen());
                document.getElementById('vr-mode').addEventListener('click', () => this.enterVR());
                
                // Scene selector
                document.getElementById('scene-selector').addEventListener('change', (e) => {
                    const sceneIndex = this.scenes.findIndex(s => s.id === e.target.value);
                    if (sceneIndex !== -1) {
                        this.goToScene(sceneIndex);
                    }
                });

                // Keyboard controls
                document.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case 'ArrowLeft':
                            this.previousScene();
                            break;
                        case 'ArrowRight':
                            this.nextScene();
                            break;
                        case ' ':
                            e.preventDefault();
                            this.toggleAutoRotate();
                            break;
                        case 'f':
                        case 'F':
                            this.toggleFullscreen();
                            break;
                        case 'v':
                        case 'V':
                            this.enterVR();
                            break;
                    }
                });
            }

            setupHotspotInteractions() {
                // Add click listeners to hotspots
                const hotspots = document.querySelectorAll('.hotspot');
                hotspots.forEach(hotspot => {
                    hotspot.addEventListener('click', (e) => {
                        const targetScene = e.target.getAttribute('data-scene');
                        const title = e.target.getAttribute('data-title');
                        
                        if (targetScene) {
                            const sceneIndex = this.scenes.findIndex(s => s.id === targetScene);
                            if (sceneIndex !== -1) {
                                this.goToScene(sceneIndex);
                                this.trackHotspotClick(title || targetScene);
                            }
                        }
                    });

                    // Add hover effects
                    hotspot.addEventListener('mouseenter', () => {
                        hotspot.setAttribute('animation', 'property: scale; to: 1.2 1.2 1.2; dur: 200');
                    });

                    hotspot.addEventListener('mouseleave', () => {
                        hotspot.setAttribute('animation', 'property: scale; to: 1 1 1; dur: 200');
                    });
                });

                // Info hotspot
                const infoHotspot = document.getElementById('info-hotspot');
                if (infoHotspot) {
                    infoHotspot.addEventListener('click', () => {
                        this.showTourInfo();
                    });
                }
            }

            loadTourData() {
                // Check URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const tourId = urlParams.get('tour');
                const isDemo = urlParams.get('demo') === 'true';

                if (isDemo) {
                    document.getElementById('demo-banner').classList.remove('d-none');
                    this.tourData = {
                        id: 'demo',
                        title: 'VORTITOUR Demo Tour',
                        description: 'Experience the power of 360Â° virtual tours'
                    };
                } else if (tourId) {
                    // Load tour data from Supabase
                    this.loadTourFromDatabase(tourId);
                } else {
                    // Default demo mode
                    this.tourData = {
                        id: 'default',
                        title: 'Virtual Tour',
                        description: 'Immersive 360Â° experience'
                    };
                }

                this.updateUI();
            }

            async loadTourFromDatabase(tourId) {
                try {
                    // This would load from Supabase in a real implementation
                    console.log('Loading tour:', tourId);
                    this.tourData = {
                        id: tourId,
                        title: 'Custom Virtual Tour',
                        description: 'Professional 360Â° tour experience'
                    };
                    this.updateUI();
                } catch (error) {
                    console.error('Error loading tour:', error);
                }
            }

            updateUI() {
                if (this.tourData) {
                    document.getElementById('tour-title').textContent = this.tourData.title;
                    document.title = `${this.tourData.title} - VORTITOUR`;
                }
                
                this.updateSceneInfo();
            }

            updateSceneInfo() {
                const sceneInfo = document.getElementById('scene-info');
                const currentSceneName = this.scenes[this.currentScene].name;
                sceneInfo.textContent = `${currentSceneName} (${this.currentScene + 1} of ${this.scenes.length})`;
                
                // Update scene selector
                const selector = document.getElementById('scene-selector');
                selector.value = this.scenes[this.currentScene].id;
            }

            goToScene(sceneIndex) {
                if (sceneIndex >= 0 && sceneIndex < this.scenes.length) {
                    this.currentScene = sceneIndex;
                    const scene = this.scenes[sceneIndex];
                    
                    // Update sky
                    const sky = document.getElementById('scene-sky');
                    sky.setAttribute('src', scene.sky);
                    
                    // Add transition effect
                    sky.setAttribute('animation', 'property: material.opacity; from: 0; to: 1; dur: 500');
                    
                    this.updateSceneInfo();
                    this.trackSceneChange(scene.name);
                }
            }

            previousScene() {
                const prevIndex = this.currentScene > 0 ? this.currentScene - 1 : this.scenes.length - 1;
                this.goToScene(prevIndex);
            }

            nextScene() {
                const nextIndex = this.currentScene < this.scenes.length - 1 ? this.currentScene + 1 : 0;
                this.goToScene(nextIndex);
            }

            toggleAutoRotate() {
                const camera = document.getElementById('main-camera');
                const playBtn = document.getElementById('play-pause');
                
                if (this.isAutoRotating) {
                    camera.removeAttribute('animation');
                    playBtn.innerHTML = '<i class="bi bi-play"></i>';
                    this.isAutoRotating = false;
                } else {
                    camera.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 20000');
                    playBtn.innerHTML = '<i class="bi bi-pause"></i>';
                    this.isAutoRotating = true;
                }
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            enterVR() {
                const scene = document.getElementById('vr-scene');
                if (scene.enterVR) {
                    scene.enterVR();
                }
            }

            showTourInfo() {
                const info = this.tourData ? 
                    `${this.tourData.title}\n\n${this.tourData.description || 'Immersive 360Â° virtual tour experience'}` :
                    'Virtual Tour\n\nExperience immersive 360Â° environments';
                
                alert(info);
            }

            hideLoading() {
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                }, 1500);
            }

            // Analytics tracking
            trackView() {
                if (window.VortitourAnalytics) {
                    window.VortitourAnalytics.trackEvent('tour_viewed', {
                        tour_id: this.tourData?.id || 'unknown',
                        scene_count: this.scenes.length,
                        is_demo: new URLSearchParams(window.location.search).get('demo') === 'true'
                    });
                }
            }

            trackSceneChange(sceneName) {
                if (window.VortitourAnalytics) {
                    window.VortitourAnalytics.trackEvent('scene_changed', {
                        tour_id: this.tourData?.id || 'unknown',
                        scene_name: sceneName,
                        scene_index: this.currentScene
                    });
                }
            }

            trackHotspotClick(hotspotTitle) {
                if (window.VortitourAnalytics) {
                    window.VortitourAnalytics.trackEvent('hotspot_clicked', {
                        tour_id: this.tourData?.id || 'unknown',
                        hotspot_title: hotspotTitle,
                        current_scene: this.currentScene
                    });
                }
            }
        }

        // Initialize viewer when A-Frame is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for A-Frame to load
            const scene = document.getElementById('vr-scene');
            if (scene.hasLoaded) {
                new VRTourViewer();
            } else {
                scene.addEventListener('loaded', () => {
                    new VRTourViewer();
                });
            }
        });

        // Handle VR mode changes
        document.getElementById('vr-scene').addEventListener('enter-vr', function() {
            console.log('Entered VR mode');
            if (window.VortitourAnalytics) {
                window.VortitourAnalytics.trackEvent('vr_mode_entered', {
                    tour_id: window.vrTourViewer?.tourData?.id || 'unknown'
                });
            }
        });

        document.getElementById('vr-scene').addEventListener('exit-vr', function() {
            console.log('Exited VR mode');
            if (window.VortitourAnalytics) {
                window.VortitourAnalytics.trackEvent('vr_mode_exited', {
                    tour_id: window.vrTourViewer?.tourData?.id || 'unknown'
                });
            }
        });
    </script>
</body>
</html>

