<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Editor - VORTITOUR</title>
    <meta name="description" content="Create and edit immersive 360° virtual tours with drag-and-drop interface">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Sortable.js for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
    
    <!-- Configuration -->
    <script src="/config.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .editor-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .editor-sidebar {
            background: white;
            border-right: 1px solid #dee2e6;
            height: calc(100vh - 80px);
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        
        .editor-main {
            height: calc(100vh - 80px);
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .scene-preview {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .scene-preview:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.2);
        }
        
        .scene-preview.active {
            border-color: #007bff;
            background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
        }
        
        .scene-thumbnail {
            width: 100%;
            height: 120px;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .scene-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .scene-thumbnail .placeholder {
            color: #6c757d;
            font-size: 2rem;
        }
        
        .hotspot-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #007bff;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            animation: pulse 2s infinite;
            z-index: 10;
        }
        
        .hotspot-marker:hover {
            background: #0056b3;
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }
        
        .editor-canvas {
            background: white;
            border-radius: 10px;
            margin: 20px;
            height: calc(100vh - 120px);
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .canvas-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #f8f9fa;
        }
        
        .toolbar {
            background: white;
            border-bottom: 1px solid #dee2e6;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .tool-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tool-btn:hover {
            background: #e9ecef;
            border-color: #007bff;
        }
        
        .tool-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .properties-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .upload-zone:hover {
            border-color: #007bff;
            background: rgba(0,123,255,0.05);
        }
        
        .upload-zone.dragover {
            border-color: #007bff;
            background: rgba(0,123,255,0.1);
        }
        
        .scene-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .hotspot-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .hotspot-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .hotspot-item:hover {
            background: #e9ecef;
            border-color: #007bff;
        }
        
        .hotspot-item.active {
            background: #e3f2fd;
            border-color: #007bff;
        }
        
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            z-index: 1000;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
        }
        
        .save-indicator.show {
            transform: translateY(0);
        }
        
        .modal-backdrop {
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        
        .progress-bar {
            height: 4px;
            background: linear-gradient(90deg, #007bff, #28a745);
            border-radius: 2px;
        }
        
        .scene-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .scene-preview:hover .scene-actions {
            opacity: 1;
        }
        
        .action-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            background: #007bff;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Save Indicator -->
    <div id="save-indicator" class="save-indicator">
        <i class="bi bi-check-circle me-2"></i>
        <span>Changes saved automatically</span>
    </div>

    <!-- Header -->
    <div class="editor-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <a href="../index.html" class="text-white text-decoration-none me-3">
                            <i class="bi bi-arrow-left fs-4"></i>
                        </a>
                        <h4 class="mb-0">
                            <i class="bi bi-pencil-square me-2"></i>
                            <span id="tour-title">Tour Editor</span>
                        </h4>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group me-3">
                        <button class="btn btn-outline-light" id="preview-btn">
                            <i class="bi bi-eye me-1"></i>
                            <span data-i18n="editor.preview">Preview</span>
                        </button>
                        <button class="btn btn-outline-light" id="publish-btn">
                            <i class="bi bi-cloud-upload me-1"></i>
                            <span data-i18n="editor.publish">Publish</span>
                        </button>
                    </div>
                    <button class="btn btn-light" id="save-btn">
                        <i class="bi bi-save me-1"></i>
                        <span data-i18n="editor.save">Save</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 p-0">
                <div class="editor-sidebar">
                    <!-- Toolbar -->
                    <div class="toolbar">
                        <div class="tool-btn active" id="select-tool" data-tool="select" title="Select Tool">
                            <i class="bi bi-cursor"></i>
                        </div>
                        <div class="tool-btn" id="hotspot-tool" data-tool="hotspot" title="Add Hotspot">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                        <div class="tool-btn" id="info-tool" data-tool="info" title="Add Info Point">
                            <i class="bi bi-info-circle"></i>
                        </div>
                        <div class="tool-btn" id="link-tool" data-tool="link" title="Add Link">
                            <i class="bi bi-link-45deg"></i>
                        </div>
                    </div>

                    <!-- Tour Settings -->
                    <div class="p-3 border-bottom">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-gear me-2"></i>
                            <span data-i18n="editor.tourSettings">Tour Settings</span>
                        </h6>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="editor.tourName">Tour Name</label>
                            <input type="text" class="form-control" id="tour-name" placeholder="Enter tour name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="editor.description">Description</label>
                            <textarea class="form-control" id="tour-description" rows="3" placeholder="Tour description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="editor.category">Category</label>
                            <select class="form-select" id="tour-category">
                                <option value="real-estate">Real Estate</option>
                                <option value="hospitality">Hospitality</option>
                                <option value="retail">Retail</option>
                                <option value="education">Education</option>
                                <option value="museum">Museum</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Scene Management -->
                    <div class="p-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">
                                <i class="bi bi-collection me-2"></i>
                                <span data-i18n="editor.scenes">Scenes</span>
                            </h6>
                            <button class="btn btn-sm btn-primary" id="add-scene-btn">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        
                        <!-- Upload Zone -->
                        <div class="upload-zone" id="upload-zone">
                            <i class="bi bi-cloud-upload fs-1 text-muted mb-2"></i>
                            <p class="mb-2" data-i18n="editor.uploadImages">Drop 360° images here</p>
                            <small class="text-muted" data-i18n="editor.supportedFormats">Supports JPG, PNG (max 10MB)</small>
                            <input type="file" id="file-input" multiple accept="image/*" style="display: none;">
                        </div>

                        <!-- Scene List -->
                        <div class="scene-list" id="scene-list">
                            <!-- Scenes will be populated here -->
                        </div>
                    </div>

                    <!-- Hotspot Management -->
                    <div class="p-3">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-geo-alt me-2"></i>
                            <span data-i18n="editor.hotspots">Hotspots</span>
                        </h6>
                        <div class="hotspot-list" id="hotspot-list">
                            <p class="text-muted text-center" data-i18n="editor.noHotspots">No hotspots added yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Editor -->
            <div class="col-md-6 p-0">
                <div class="editor-main">
                    <div class="editor-canvas" id="editor-canvas">
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <div class="text-center">
                                <i class="bi bi-image fs-1 mb-3"></i>
                                <h5 data-i18n="editor.selectScene">Select a scene to start editing</h5>
                                <p data-i18n="editor.uploadInstructions">Upload 360° images to create your virtual tour</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Properties Panel -->
            <div class="col-md-3 p-0">
                <div class="properties-panel">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-sliders me-2"></i>
                        <span data-i18n="editor.properties">Properties</span>
                    </h6>
                    
                    <div id="properties-content">
                        <div class="text-center text-muted">
                            <i class="bi bi-cursor fs-1 mb-3"></i>
                            <p data-i18n="editor.selectElement">Select an element to edit properties</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hotspot Modal -->
    <div class="modal fade" id="hotspot-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>
                        <span data-i18n="editor.addHotspot">Add Hotspot</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" data-i18n="editor.hotspotType">Hotspot Type</label>
                        <select class="form-select" id="hotspot-type">
                            <option value="navigation">Navigation</option>
                            <option value="info">Information</option>
                            <option value="link">External Link</option>
                            <option value="media">Media</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="editor.title">Title</label>
                        <input type="text" class="form-control" id="hotspot-title" placeholder="Hotspot title">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="editor.description">Description</label>
                        <textarea class="form-control" id="hotspot-description" rows="3" placeholder="Hotspot description"></textarea>
                    </div>
                    <div class="mb-3" id="target-scene-group">
                        <label class="form-label" data-i18n="editor.targetScene">Target Scene</label>
                        <select class="form-select" id="target-scene">
                            <option value="">Select scene</option>
                        </select>
                    </div>
                    <div class="mb-3" id="link-url-group" style="display: none;">
                        <label class="form-label" data-i18n="editor.url">URL</label>
                        <input type="url" class="form-control" id="hotspot-url" placeholder="https://example.com">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-hotspot-btn" data-i18n="common.save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scene Settings Modal -->
    <div class="modal fade" id="scene-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear me-2"></i>
                        <span data-i18n="editor.sceneSettings">Scene Settings</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" data-i18n="editor.sceneName">Scene Name</label>
                        <input type="text" class="form-control" id="scene-name" placeholder="Scene name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="editor.sceneDescription">Description</label>
                        <textarea class="form-control" id="scene-description" rows="3" placeholder="Scene description"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="editor.initialView">Initial View</label>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label small">Yaw (°)</label>
                                <input type="number" class="form-control" id="scene-yaw" value="0" min="-180" max="180">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Pitch (°)</label>
                                <input type="number" class="form-control" id="scene-pitch" value="0" min="-90" max="90">
                            </div>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="scene-autorotate">
                        <label class="form-check-label" for="scene-autorotate" data-i18n="editor.autoRotate">
                            Auto-rotate scene
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-scene-btn" data-i18n="common.save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/i18n.js"></script>
    <script src="../../js/supabase-client.js"></script>
    <script src="../../js/cloudinary-client.js"></script>
    <script src="../../js/analytics.js"></script>

    <script>
        // Tour Editor Application
        class TourEditor {
            constructor() {
                this.currentTool = 'select';
                this.currentScene = null;
                this.selectedHotspot = null;
                this.tourData = {
                    id: null,
                    name: 'New Tour',
                    description: '',
                    category: 'real-estate',
                    scenes: [],
                    settings: {
                        autoSave: true,
                        showUI: true,
                        enableVR: true
                    }
                };
                this.isDirty = false;
                this.autoSaveInterval = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.setupAutoSave();
                this.loadTourData();
                this.updateUI();
                this.trackEditorOpen();
            }

            setupEventListeners() {
                // Tool selection
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectTool(e.currentTarget.dataset.tool);
                    });
                });

                // Tour settings
                document.getElementById('tour-name').addEventListener('input', (e) => {
                    this.tourData.name = e.target.value;
                    this.markDirty();
                    this.updateTitle();
                });

                document.getElementById('tour-description').addEventListener('input', (e) => {
                    this.tourData.description = e.target.value;
                    this.markDirty();
                });

                document.getElementById('tour-category').addEventListener('change', (e) => {
                    this.tourData.category = e.target.value;
                    this.markDirty();
                });

                // File upload
                document.getElementById('file-input').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files);
                });

                // Add scene button
                document.getElementById('add-scene-btn').addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });

                // Header buttons
                document.getElementById('save-btn').addEventListener('click', () => {
                    this.saveTour();
                });

                document.getElementById('preview-btn').addEventListener('click', () => {
                    this.previewTour();
                });

                document.getElementById('publish-btn').addEventListener('click', () => {
                    this.publishTour();
                });

                // Hotspot modal
                document.getElementById('hotspot-type').addEventListener('change', (e) => {
                    this.updateHotspotModal(e.target.value);
                });

                document.getElementById('save-hotspot-btn').addEventListener('click', () => {
                    this.saveHotspot();
                });

                document.getElementById('save-scene-btn').addEventListener('click', () => {
                    this.saveSceneSettings();
                });

                // Canvas interactions
                document.getElementById('editor-canvas').addEventListener('click', (e) => {
                    this.handleCanvasClick(e);
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    this.handleKeyboard(e);
                });
            }

            setupDragAndDrop() {
                const uploadZone = document.getElementById('upload-zone');
                
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });

                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });

                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    this.handleFileUpload(e.dataTransfer.files);
                });

                uploadZone.addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });

                // Make scene list sortable
                const sceneList = document.getElementById('scene-list');
                Sortable.create(sceneList, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        this.reorderScenes(evt.oldIndex, evt.newIndex);
                    }
                });
            }

            setupAutoSave() {
                if (this.tourData.settings.autoSave) {
                    this.autoSaveInterval = setInterval(() => {
                        if (this.isDirty) {
                            this.saveTour(true);
                        }
                    }, 30000); // Auto-save every 30 seconds
                }
            }

            selectTool(tool) {
                this.currentTool = tool;
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
                
                // Update cursor
                const canvas = document.getElementById('editor-canvas');
                canvas.style.cursor = tool === 'select' ? 'default' : 'crosshair';
            }

            async handleFileUpload(files) {
                const validFiles = Array.from(files).filter(file => 
                    file.type.startsWith('image/') && file.size <= 10 * 1024 * 1024
                );

                if (validFiles.length === 0) {
                    this.showToast('Please select valid image files (max 10MB)', 'error');
                    return;
                }

                for (const file of validFiles) {
                    await this.uploadScene(file);
                }
            }

            async uploadScene(file) {
                try {
                    // Show upload progress
                    const progressId = this.showUploadProgress(file.name);
                    
                    // Upload to Cloudinary
                    const uploadResult = await this.uploadToCloudinary(file);
                    
                    // Create scene object
                    const scene = {
                        id: this.generateId(),
                        name: file.name.replace(/\.[^/.]+$/, ""),
                        description: '',
                        imageUrl: uploadResult.secure_url,
                        thumbnail: uploadResult.eager?.[0]?.secure_url || uploadResult.secure_url,
                        hotspots: [],
                        settings: {
                            yaw: 0,
                            pitch: 0,
                            autoRotate: false
                        }
                    };

                    this.tourData.scenes.push(scene);
                    this.markDirty();
                    this.updateSceneList();
                    this.hideUploadProgress(progressId);
                    this.showToast(`Scene "${scene.name}" uploaded successfully`, 'success');
                    
                    // Select the new scene
                    this.selectScene(scene.id);
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    this.showToast('Failed to upload image', 'error');
                }
            }

            async uploadToCloudinary(file) {
                // This would use the Cloudinary upload widget or API
                // For demo purposes, we'll simulate the upload
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            secure_url: URL.createObjectURL(file),
                            eager: [{
                                secure_url: URL.createObjectURL(file)
                            }]
                        });
                    }, 1000);
                });
            }

            updateSceneList() {
                const sceneList = document.getElementById('scene-list');
                sceneList.innerHTML = '';

                this.tourData.scenes.forEach((scene, index) => {
                    const sceneElement = this.createSceneElement(scene, index);
                    sceneList.appendChild(sceneElement);
                });
            }

            createSceneElement(scene, index) {
                const div = document.createElement('div');
                div.className = `scene-preview ${this.currentScene?.id === scene.id ? 'active' : ''}`;
                div.dataset.sceneId = scene.id;
                
                div.innerHTML = `
                    <div class="scene-thumbnail">
                        <img src="${scene.thumbnail}" alt="${scene.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="placeholder" style="display: none;">
                            <i class="bi bi-image"></i>
                        </div>
                        ${scene.hotspots.map(hotspot => 
                            `<div class="hotspot-marker" style="left: ${hotspot.x}%; top: ${hotspot.y}%;" title="${hotspot.title}"></div>`
                        ).join('')}
                    </div>
                    <div class="scene-actions">
                        <button class="action-btn" onclick="tourEditor.editScene('${scene.id}')" title="Edit Scene">
                            <i class="bi bi-gear"></i>
                        </button>
                        <button class="action-btn" onclick="tourEditor.duplicateScene('${scene.id}')" title="Duplicate Scene">
                            <i class="bi bi-files"></i>
                        </button>
                        <button class="action-btn" onclick="tourEditor.deleteScene('${scene.id}')" title="Delete Scene">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="fw-bold">${scene.name}</div>
                    <small class="text-muted">${scene.hotspots.length} hotspots</small>
                `;

                div.addEventListener('click', () => {
                    this.selectScene(scene.id);
                });

                return div;
            }

            selectScene(sceneId) {
                this.currentScene = this.tourData.scenes.find(s => s.id === sceneId);
                this.selectedHotspot = null;
                
                // Update UI
                this.updateSceneList();
                this.updateCanvas();
                this.updateHotspotList();
                this.updatePropertiesPanel();
            }

            updateCanvas() {
                const canvas = document.getElementById('editor-canvas');
                
                if (!this.currentScene) {
                    canvas.innerHTML = `
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <div class="text-center">
                                <i class="bi bi-image fs-1 mb-3"></i>
                                <h5 data-i18n="editor.selectScene">Select a scene to start editing</h5>
                                <p data-i18n="editor.uploadInstructions">Upload 360° images to create your virtual tour</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                canvas.innerHTML = `
                    <img src="${this.currentScene.imageUrl}" alt="${this.currentScene.name}" class="canvas-image">
                    ${this.currentScene.hotspots.map(hotspot => 
                        `<div class="hotspot-marker ${this.selectedHotspot?.id === hotspot.id ? 'active' : ''}" 
                              style="left: ${hotspot.x}%; top: ${hotspot.y}%;" 
                              data-hotspot-id="${hotspot.id}"
                              title="${hotspot.title}"></div>`
                    ).join('')}
                `;

                // Add hotspot click listeners
                canvas.querySelectorAll('.hotspot-marker').forEach(marker => {
                    marker.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.selectHotspot(marker.dataset.hotspotId);
                    });
                });
            }

            handleCanvasClick(e) {
                if (!this.currentScene) return;

                const rect = e.currentTarget.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;

                if (this.currentTool === 'hotspot' || this.currentTool === 'info' || this.currentTool === 'link') {
                    this.addHotspot(x, y, this.currentTool);
                } else if (this.currentTool === 'select') {
                    this.selectedHotspot = null;
                    this.updateCanvas();
                    this.updatePropertiesPanel();
                }
            }

            addHotspot(x, y, type) {
                // Show hotspot modal
                const modal = new bootstrap.Modal(document.getElementById('hotspot-modal'));
                document.getElementById('hotspot-type').value = type;
                this.updateHotspotModal(type);
                
                // Store position for when modal is saved
                this.pendingHotspot = { x, y, type };
                modal.show();
            }

            updateHotspotModal(type) {
                const targetSceneGroup = document.getElementById('target-scene-group');
                const linkUrlGroup = document.getElementById('link-url-group');
                
                if (type === 'navigation') {
                    targetSceneGroup.style.display = 'block';
                    linkUrlGroup.style.display = 'none';
                    this.updateTargetSceneOptions();
                } else if (type === 'link') {
                    targetSceneGroup.style.display = 'none';
                    linkUrlGroup.style.display = 'block';
                } else {
                    targetSceneGroup.style.display = 'none';
                    linkUrlGroup.style.display = 'none';
                }
            }

            updateTargetSceneOptions() {
                const select = document.getElementById('target-scene');
                select.innerHTML = '<option value="">Select scene</option>';
                
                this.tourData.scenes.forEach(scene => {
                    if (scene.id !== this.currentScene.id) {
                        const option = document.createElement('option');
                        option.value = scene.id;
                        option.textContent = scene.name;
                        select.appendChild(option);
                    }
                });
            }

            saveHotspot() {
                if (!this.pendingHotspot || !this.currentScene) return;

                const hotspot = {
                    id: this.generateId(),
                    type: document.getElementById('hotspot-type').value,
                    title: document.getElementById('hotspot-title').value,
                    description: document.getElementById('hotspot-description').value,
                    x: this.pendingHotspot.x,
                    y: this.pendingHotspot.y,
                    targetScene: document.getElementById('target-scene').value,
                    url: document.getElementById('hotspot-url').value
                };

                this.currentScene.hotspots.push(hotspot);
                this.markDirty();
                this.updateCanvas();
                this.updateHotspotList();
                this.updateSceneList();
                
                // Clear form
                document.getElementById('hotspot-title').value = '';
                document.getElementById('hotspot-description').value = '';
                document.getElementById('hotspot-url').value = '';
                
                bootstrap.Modal.getInstance(document.getElementById('hotspot-modal')).hide();
                this.pendingHotspot = null;
                
                this.showToast('Hotspot added successfully', 'success');
            }

            selectHotspot(hotspotId) {
                this.selectedHotspot = this.currentScene.hotspots.find(h => h.id === hotspotId);
                this.updateCanvas();
                this.updateHotspotList();
                this.updatePropertiesPanel();
            }

            updateHotspotList() {
                const hotspotList = document.getElementById('hotspot-list');
                
                if (!this.currentScene || this.currentScene.hotspots.length === 0) {
                    hotspotList.innerHTML = '<p class="text-muted text-center" data-i18n="editor.noHotspots">No hotspots added yet</p>';
                    return;
                }

                hotspotList.innerHTML = this.currentScene.hotspots.map(hotspot => `
                    <div class="hotspot-item ${this.selectedHotspot?.id === hotspot.id ? 'active' : ''}" 
                         data-hotspot-id="${hotspot.id}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold">${hotspot.title || 'Untitled Hotspot'}</div>
                                <small class="text-muted">${hotspot.type}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="tourEditor.deleteHotspot('${hotspot.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                // Add click listeners
                hotspotList.querySelectorAll('.hotspot-item').forEach(item => {
                    item.addEventListener('click', () => {
                        this.selectHotspot(item.dataset.hotspotId);
                    });
                });
            }

            updatePropertiesPanel() {
                const content = document.getElementById('properties-content');
                
                if (this.selectedHotspot) {
                    content.innerHTML = this.createHotspotProperties(this.selectedHotspot);
                } else if (this.currentScene) {
                    content.innerHTML = this.createSceneProperties(this.currentScene);
                } else {
                    content.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="bi bi-cursor fs-1 mb-3"></i>
                            <p data-i18n="editor.selectElement">Select an element to edit properties</p>
                        </div>
                    `;
                }
            }

            createHotspotProperties(hotspot) {
                return `
                    <h6 class="fw-bold mb-3">Hotspot Properties</h6>
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" value="${hotspot.title}" 
                               onchange="tourEditor.updateHotspotProperty('${hotspot.id}', 'title', this.value)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" rows="3" 
                                  onchange="tourEditor.updateHotspotProperty('${hotspot.id}', 'description', this.value)">${hotspot.description}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Position</label>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label small">X (%)</label>
                                <input type="number" class="form-control" value="${hotspot.x.toFixed(1)}" step="0.1"
                                       onchange="tourEditor.updateHotspotProperty('${hotspot.id}', 'x', parseFloat(this.value))">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Y (%)</label>
                                <input type="number" class="form-control" value="${hotspot.y.toFixed(1)}" step="0.1"
                                       onchange="tourEditor.updateHotspotProperty('${hotspot.id}', 'y', parseFloat(this.value))">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm w-100" onclick="tourEditor.deleteHotspot('${hotspot.id}')">
                        <i class="bi bi-trash me-1"></i>
                        Delete Hotspot
                    </button>
                `;
            }

            createSceneProperties(scene) {
                return `
                    <h6 class="fw-bold mb-3">Scene Properties</h6>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" value="${scene.name}" 
                               onchange="tourEditor.updateSceneProperty('${scene.id}', 'name', this.value)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" rows="3" 
                                  onchange="tourEditor.updateSceneProperty('${scene.id}', 'description', this.value)">${scene.description}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initial View</label>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label small">Yaw (°)</label>
                                <input type="number" class="form-control" value="${scene.settings.yaw}" min="-180" max="180"
                                       onchange="tourEditor.updateSceneProperty('${scene.id}', 'settings.yaw', parseInt(this.value))">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Pitch (°)</label>
                                <input type="number" class="form-control" value="${scene.settings.pitch}" min="-90" max="90"
                                       onchange="tourEditor.updateSceneProperty('${scene.id}', 'settings.pitch', parseInt(this.value))">
                            </div>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" ${scene.settings.autoRotate ? 'checked' : ''}
                               onchange="tourEditor.updateSceneProperty('${scene.id}', 'settings.autoRotate', this.checked)">
                        <label class="form-check-label">Auto-rotate scene</label>
                    </div>
                `;
            }

            updateHotspotProperty(hotspotId, property, value) {
                const hotspot = this.currentScene.hotspots.find(h => h.id === hotspotId);
                if (hotspot) {
                    hotspot[property] = value;
                    this.markDirty();
                    this.updateCanvas();
                    this.updateHotspotList();
                }
            }

            updateSceneProperty(sceneId, property, value) {
                const scene = this.tourData.scenes.find(s => s.id === sceneId);
                if (scene) {
                    if (property.includes('.')) {
                        const [parent, child] = property.split('.');
                        scene[parent][child] = value;
                    } else {
                        scene[property] = value;
                    }
                    this.markDirty();
                    this.updateSceneList();
                    if (property === 'name') {
                        this.updateTargetSceneOptions();
                    }
                }
            }

            deleteHotspot(hotspotId) {
                if (confirm('Are you sure you want to delete this hotspot?')) {
                    this.currentScene.hotspots = this.currentScene.hotspots.filter(h => h.id !== hotspotId);
                    this.selectedHotspot = null;
                    this.markDirty();
                    this.updateCanvas();
                    this.updateHotspotList();
                    this.updateSceneList();
                    this.updatePropertiesPanel();
                    this.showToast('Hotspot deleted', 'success');
                }
            }

            deleteScene(sceneId) {
                if (confirm('Are you sure you want to delete this scene?')) {
                    this.tourData.scenes = this.tourData.scenes.filter(s => s.id !== sceneId);
                    if (this.currentScene?.id === sceneId) {
                        this.currentScene = null;
                        this.selectedHotspot = null;
                    }
                    this.markDirty();
                    this.updateSceneList();
                    this.updateCanvas();
                    this.updateHotspotList();
                    this.updatePropertiesPanel();
                    this.showToast('Scene deleted', 'success');
                }
            }

            duplicateScene(sceneId) {
                const scene = this.tourData.scenes.find(s => s.id === sceneId);
                if (scene) {
                    const duplicatedScene = {
                        ...JSON.parse(JSON.stringify(scene)),
                        id: this.generateId(),
                        name: `${scene.name} (Copy)`,
                        hotspots: scene.hotspots.map(h => ({
                            ...h,
                            id: this.generateId()
                        }))
                    };
                    this.tourData.scenes.push(duplicatedScene);
                    this.markDirty();
                    this.updateSceneList();
                    this.showToast('Scene duplicated', 'success');
                }
            }

            editScene(sceneId) {
                const scene = this.tourData.scenes.find(s => s.id === sceneId);
                if (scene) {
                    document.getElementById('scene-name').value = scene.name;
                    document.getElementById('scene-description').value = scene.description;
                    document.getElementById('scene-yaw').value = scene.settings.yaw;
                    document.getElementById('scene-pitch').value = scene.settings.pitch;
                    document.getElementById('scene-autorotate').checked = scene.settings.autoRotate;
                    
                    this.editingSceneId = sceneId;
                    const modal = new bootstrap.Modal(document.getElementById('scene-modal'));
                    modal.show();
                }
            }

            saveSceneSettings() {
                if (this.editingSceneId) {
                    const scene = this.tourData.scenes.find(s => s.id === this.editingSceneId);
                    if (scene) {
                        scene.name = document.getElementById('scene-name').value;
                        scene.description = document.getElementById('scene-description').value;
                        scene.settings.yaw = parseInt(document.getElementById('scene-yaw').value);
                        scene.settings.pitch = parseInt(document.getElementById('scene-pitch').value);
                        scene.settings.autoRotate = document.getElementById('scene-autorotate').checked;
                        
                        this.markDirty();
                        this.updateSceneList();
                        this.updatePropertiesPanel();
                        
                        bootstrap.Modal.getInstance(document.getElementById('scene-modal')).hide();
                        this.showToast('Scene settings saved', 'success');
                    }
                }
            }

            reorderScenes(oldIndex, newIndex) {
                const scene = this.tourData.scenes.splice(oldIndex, 1)[0];
                this.tourData.scenes.splice(newIndex, 0, scene);
                this.markDirty();
            }

            handleKeyboard(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            this.saveTour();
                            break;
                        case 'z':
                            e.preventDefault();
                            // Implement undo
                            break;
                        case 'y':
                            e.preventDefault();
                            // Implement redo
                            break;
                    }
                }

                if (e.key === 'Delete' && this.selectedHotspot) {
                    this.deleteHotspot(this.selectedHotspot.id);
                }
            }

            async saveTour(isAutoSave = false) {
                try {
                    // Save to Supabase
                    if (window.VortitourSupabase) {
                        await window.VortitourSupabase.saveTour(this.tourData);
                    }
                    
                    this.isDirty = false;
                    
                    if (!isAutoSave) {
                        this.showToast('Tour saved successfully', 'success');
                    } else {
                        this.showSaveIndicator();
                    }
                    
                } catch (error) {
                    console.error('Save error:', error);
                    this.showToast('Failed to save tour', 'error');
                }
            }

            previewTour() {
                if (this.tourData.scenes.length === 0) {
                    this.showToast('Add at least one scene to preview', 'warning');
                    return;
                }
                
                // Save current state and open preview
                this.saveTour().then(() => {
                    const previewUrl = `viewer.html?tour=${this.tourData.id}&preview=true`;
                    window.open(previewUrl, '_blank');
                });
            }

            async publishTour() {
                if (this.tourData.scenes.length === 0) {
                    this.showToast('Add at least one scene to publish', 'warning');
                    return;
                }
                
                try {
                    await this.saveTour();
                    
                    // Update tour status to published
                    this.tourData.status = 'published';
                    this.tourData.publishedAt = new Date().toISOString();
                    
                    await this.saveTour();
                    
                    this.showToast('Tour published successfully!', 'success');
                    
                } catch (error) {
                    console.error('Publish error:', error);
                    this.showToast('Failed to publish tour', 'error');
                }
            }

            loadTourData() {
                // Load tour from URL parameter or create new
                const urlParams = new URLSearchParams(window.location.search);
                const tourId = urlParams.get('tour');
                
                if (tourId) {
                    this.loadExistingTour(tourId);
                } else {
                    this.tourData.id = this.generateId();
                }
            }

            async loadExistingTour(tourId) {
                try {
                    if (window.VortitourSupabase) {
                        const tourData = await window.VortitourSupabase.getTour(tourId);
                        if (tourData) {
                            this.tourData = tourData;
                            this.updateUI();
                            this.updateSceneList();
                        }
                    }
                } catch (error) {
                    console.error('Load error:', error);
                    this.showToast('Failed to load tour', 'error');
                }
            }

            updateUI() {
                document.getElementById('tour-name').value = this.tourData.name;
                document.getElementById('tour-description').value = this.tourData.description;
                document.getElementById('tour-category').value = this.tourData.category;
                this.updateTitle();
            }

            updateTitle() {
                document.getElementById('tour-title').textContent = this.tourData.name;
                document.title = `${this.tourData.name} - Tour Editor - VORTITOUR`;
            }

            markDirty() {
                this.isDirty = true;
            }

            showSaveIndicator() {
                const indicator = document.getElementById('save-indicator');
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }

            showUploadProgress(filename) {
                // Implementation for upload progress
                return Date.now();
            }

            hideUploadProgress(progressId) {
                // Implementation for hiding upload progress
            }

            showToast(message, type = 'info') {
                if (window.VortitourApp && window.VortitourApp.showToast) {
                    window.VortitourApp.showToast(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            generateId() {
                return 'id_' + Math.random().toString(36).substr(2, 9);
            }

            trackEditorOpen() {
                if (window.VortitourAnalytics) {
                    window.VortitourAnalytics.trackEvent('editor_opened', {
                        tour_id: this.tourData.id,
                        is_new_tour: !this.tourData.scenes.length
                    });
                }
            }
        }

        // Initialize editor when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize i18n
            if (window.VortitourI18n) {
                window.VortitourI18n.init();
            }
            
            // Initialize editor
            window.tourEditor = new TourEditor();
        });
    </script>
</body>
</html>

